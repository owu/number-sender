# number sender

Number-sender is a tool for classifying and managing incremental numbers based on preset rules, designed for scenarios that require assigning unique numbers to entities (such as: assigning user IDs during user registration, assigning live room IDs to anchors, or assigning group numbers to chat groups, etc.). In actual business scenarios, developers can obtain numbers by specifying types (for example: assigning regular numbers to ordinary users, and exclusive premium numbers to paying users).

---

English | [中文](./README_cn.md) | [日本語](./README_jp.md)

## 1. Compilation
```
go mod vendor && CGO_ENABLED=0 GOOS=linux GOARCH=amd64 go build -o number-sender-go main.go

```

## 2. Running
```
./number-sender-go --config=config/config-test.toml

The app.env variable in the configuration file is "test" for offline environments and "prod" for production environments.
In the interface authentication middleware /internal/pkg/mware/auth.go, it is determined that test does not require authentication, which is convenient for testing.
```


## 3. API Interfaces
### 3.1 Service Status Check
- Request Example:
```
curl \
-H "Token:f98f84f7939a56f6ec8c42ef088139f5" \
-H "Milli:1746460799000" \
'http://localhost:8080/ping'
```

- Response Example:
```
{"data":{"time":1747067149074},"error":0,"msg":"success"}
```
---

### 3.2 Query the Quantity of Each Plan in Cache
- Request Example:
```
curl \
-H "Token:f98f84f7939a56f6ec8c42ef088139f5" \
-H "Milli:1746460799000" \
'http://localhost:8080/api/len'

```
- Response Example:
```
{"data":{"starter":3472008,"standard":2237018,"premium":82317,"ultimate":5657},"error":0,"msg":"success"}
```

### 3.3 Get Number for Specified Plan
- Request Example:

```
# {:plan} can be replaced with starter, standard, premium, ultimate.

curl \
-H "Token:f98f84f7939a56f6ec8c42ef088139f5" \
-H "Milli:1746460799000" \
'http://localhost:8080/api/pop/{:plan}'
```
- Response Example:
```
{"data":{"starter":0,"standard":0,"premium":0,"ultimate":10101},"error":0,"msg":"success"}
```

### 3.4 API Authentication Protocol
```
Request Header: Milli, Timestamp (in milliseconds format)
Request Header: Token, Generated by md5({Milli},{Encrypt})

---

Token Generation Example:
{Milli} is the current millisecond timestamp, assuming it is 1746460799000
{Encrypt} is configured in the config/config-*.toml file, assuming the api.encrypt value is 9b0b7484bc65e241804ce8eeb014f247

Then Token = MD5(1746460799000,9b0b7484bc65e241804ce8eeb014f247) = f98f84f7939a56f6ec8c42ef088139f5
```


## 4. Docker Deployment

### 4.0 Project Preparation

Before proceeding with Docker deployment, you need to clone the project code and switch to the specified branch:

```bash
git clone https://github.com/owu/number-sender.git && cd number-sender && git checkout main && git pull && chmod 777 -R ./docker && chmod +x docker-tools.sh
```

### 4.1 Docker Tool Script

The project provides an integrated Docker management script `docker-tools.sh` to simplify Docker image building, container management, and image migration operations.

#### Features
- Integrates delivery image building, container start/stop, log viewing, and image migration functions
- Supports both interactive selection and command-line parameter usage
- Displays the actual Docker commands being executed for each operation, increasing transparency
- Modular design for easy later maintenance and expansion

#### Usage

##### Interactive Mode
```bash
./docker-tools.sh
```

After running, the following menu will be displayed. Enter the corresponding letter to select an operation:
```
========================================
Docker Tool Script
========================================
Please select an operation:
b) Build Docker Image (docker build)
d) Stop Docker Containers (docker compose down)
l) View Container Logs (docker logs)
m) Image Migration (docker save/load)
u) Start Docker Containers (docker compose up -d)
Press Enter directly to exit the script
```

##### Command-line Parameter Mode
```bash
./docker-tools.sh [option]
```

Supported options:
- `b` : Build Docker image
- `d` : Stop Docker containers
- `l` : View container logs
- `m` : Execute image migration function (enter submenu)
- `u` : Start Docker containers
- `h` : Display help information

#### Function Descriptions

1. **Build Docker Image (b)**
   - Checks if the image already exists to avoid duplicate builds
   - Checks if the image is running to ensure build safety
   - Automatically updates the image version in docker-compose.yml

2. **Start Docker Containers (u)**
   - Uses `docker compose up -d` to start containers
   - Displays container startup status

3. **Stop Docker Containers (d)**
   - Uses `docker compose down` to stop containers
   - Displays the list of currently running containers

4. **View Container Logs (l)**
   - Uses `docker logs number-sender` to view container logs

5. **Image Migration (m)**
   - Exports images to local files (using `docker save`)
   - Imports images from local files (using `docker load`)
   - Supports interactive selection of export or import operations

#### Image Migration Submenu
When you select option `m`, you will enter the image migration submenu:
```
========================================
Docker Image Migration Function
Current Configuration:
  Image Name: number-sender
  Image Version: 0.0.1
  Full Image Name: number-sender:0.0.1
  Export File Name: number-sender.0.0.1.tar
========================================
Please select an operation:
1) Export Image (docker save)
2) Import Image (docker load)
Press Enter directly to exit image migration function
```

### 4.2 Traditional Docker Deployment Method (Optional)

If you need to deploy using traditional methods, you can also manually execute the following commands:

1. Build Image:
```bash
docker build -t number-sender:0.0.1 .
```

2. Start Containers:
```bash
docker compose up -d
```

3. Stop Containers:
```bash
docker compose down
```

4. View Logs:
```bash
docker logs number-sender
```

5. Image Migration:
```bash
# Export Image
docker save -o number-sender.0.0.1.tar number-sender:0.0.1

# Import Image
docker load -i number-sender.0.0.1.tar
```
